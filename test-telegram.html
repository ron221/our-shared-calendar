<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª Telegram é€šçŸ¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
        }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Telegram é€šçŸ¥åŠŸèƒ½æ¸¬è©¦</h1>

        <div class="test-section">
            <h3>ğŸ“± é…ç½®ç‹€æ…‹</h3>
            <div id="configStatus" class="status">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦é€šçŸ¥</h3>
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ¸¬è©¦ä¸åŒé¡å‹çš„é€šçŸ¥ï¼š</p>

            <button onclick="testInvitation()">ğŸ“© æ¸¬è©¦é‚€è«‹é€šçŸ¥</button>
            <button onclick="testAccepted()">âœ… æ¸¬è©¦æ¥å—é€šçŸ¥</button>
            <button onclick="testRejected()">âŒ æ¸¬è©¦æ‹’çµ•é€šçŸ¥</button>
            <button onclick="testReminder()">â° æ¸¬è©¦æé†’é€šçŸ¥</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦çµæœ</h3>
            <div id="testResults" class="status">ç­‰å¾…æ¸¬è©¦...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ› ï¸ æ§åˆ¶å°æ—¥èªŒ</h3>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            <pre id="consoleLog"></pre>
        </div>
    </div>

    <!-- è¼‰å…¥é…ç½®æ–‡ä»¶ -->
    <script src="telegram-config.js"></script>

    <script>
        // æ¨¡æ“¬ä¸€äº›å¿…è¦çš„å…¨åŸŸè®Šæ•¸å’Œå‡½æ•¸
        let currentUser = 'cat';
        let telegramConfig = null;
        let isTelegramEnabled = false;

        // é‡å®šå‘ console.log åˆ°é é¢
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function logToPage(type, ...args) {
            const logElement = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            logElement.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;

            // ä¹Ÿè¼¸å‡ºåˆ°çœŸå¯¦çš„æ§åˆ¶å°
            if (type === 'log') originalLog(...args);
            else if (type === 'error') originalError(...args);
            else if (type === 'warn') originalWarn(...args);
        }

        console.log = (...args) => logToPage('log', ...args);
        console.error = (...args) => logToPage('error', ...args);
        console.warn = (...args) => logToPage('warn', ...args);

        // æ¨¡æ“¬é€šçŸ¥å‡½æ•¸
        function showNotification(message, type = 'info') {
            console.log(`é€šçŸ¥ (${type}): ${message}`);

            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML += `<div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                <strong>${type.toUpperCase()}:</strong> ${message}
            </div>`;
        }

        // åˆå§‹åŒ– Telegram é€šçŸ¥
        function initializeTelegram() {
            console.log('ğŸ“± åˆå§‹åŒ– Telegram é€šçŸ¥åŠŸèƒ½...');

            try {
                // æª¢æŸ¥é…ç½®æ˜¯å¦è¼‰å…¥
                const config = window.TELEGRAM_CONFIG;
                if (!config) {
                    console.warn('âš ï¸ Telegram é…ç½®æœªè¼‰å…¥');
                    return;
                }

                telegramConfig = config;

                // æª¢æŸ¥æ˜¯å¦å•Ÿç”¨å’Œé…ç½®æ˜¯å¦å®Œæ•´
                if (config.enabled && config.botToken !== 'YOUR_BOT_TOKEN_HERE') {
                    isTelegramEnabled = true;
                    console.log('âœ… Telegram é€šçŸ¥å·²å•Ÿç”¨');
                } else if (config.testMode) {
                    telegramConfig = window.TELEGRAM_DEMO_CONFIG || config;
                    console.log('ğŸ§ª Telegram æ¸¬è©¦æ¨¡å¼å•Ÿç”¨');
                } else {
                    console.log('â¸ï¸ Telegram é€šçŸ¥æœªå•Ÿç”¨ï¼ˆéœ€è¦è¨­å®š botTokenï¼‰');
                }

                // é¡¯ç¤ºé…ç½®ç‹€æ…‹
                console.log('ğŸ“‹ Telegram é…ç½®ç‹€æ…‹:', {
                    enabled: config.enabled,
                    testMode: config.testMode,
                    hasValidToken: config.botToken !== 'YOUR_BOT_TOKEN_HERE',
                    catChatId: config.users?.cat?.chatId,
                    mouseChatId: config.users?.mouse?.chatId
                });

            } catch (error) {
                console.error('âŒ Telegram åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // ç™¼é€ Telegram é€šçŸ¥
        async function sendTelegramNotification(toUser, messageType, fromUser = null, event = null, extraData = null) {
            if (!telegramConfig || (!isTelegramEnabled && !telegramConfig.testMode)) {
                console.log('ğŸ“± Telegram é€šçŸ¥æœªå•Ÿç”¨ï¼Œè·³éç™¼é€');
                return false;
            }

            try {
                const userConfig = telegramConfig.users[toUser];
                if (!userConfig) {
                    console.error('âŒ æ‰¾ä¸åˆ°ç”¨æˆ¶é…ç½®:', toUser);
                    return false;
                }

                // ç”Ÿæˆè¨Šæ¯å…§å®¹
                const messageTemplate = telegramConfig.messages[messageType];
                if (!messageTemplate) {
                    console.error('âŒ æ‰¾ä¸åˆ°è¨Šæ¯æ¨¡æ¿:', messageType);
                    return false;
                }

                let messageText;
                switch (messageType) {
                    case 'invitation':
                    case 'accepted':
                    case 'rejected':
                        messageText = messageTemplate.template(fromUser, event);
                        break;
                    case 'reminder':
                        messageText = messageTemplate.template(event, extraData);
                        break;
                    default:
                        messageText = 'æœªçŸ¥é€šçŸ¥é¡å‹';
                }

                // æ¸¬è©¦æ¨¡å¼ï¼šåªé¡¯ç¤ºé€šçŸ¥ï¼Œä¸å¯¦éš›ç™¼é€
                if (telegramConfig.testMode || !isTelegramEnabled) {
                    console.log('ğŸ§ª Telegram æ¸¬è©¦é€šçŸ¥:', {
                        to: userConfig.name,
                        chatId: userConfig.chatId,
                        type: messageType,
                        message: messageText
                    });

                    // é¡¯ç¤ºæ¸¬è©¦é€šçŸ¥å½ˆçª—
                    showTelegramTestNotification(userConfig.name, messageTemplate.title, messageText);
                    return true;
                }

                // å¯¦éš›ç™¼é€é‚è¼¯ï¼ˆåœ¨æ¸¬è©¦é é¢ä¸­ä¸å¯¦éš›åŸ·è¡Œï¼‰
                console.log('ğŸ“¤ å¯¦éš›æ¨¡å¼ä¸‹æœƒç™¼é€åˆ° Telegram API');
                showNotification(`æœƒç™¼é€ Telegram é€šçŸ¥çµ¦ ${userConfig.name}`, 'success');
                return true;

            } catch (error) {
                console.error('âŒ Telegram é€šçŸ¥ç™¼é€éŒ¯èª¤:', error);
                showNotification('Telegram é€šçŸ¥ç™¼é€éŒ¯èª¤', 'error');
                return false;
            }
        }

        // é¡¯ç¤ºæ¸¬è©¦æ¨¡å¼çš„é€šçŸ¥å½ˆçª—
        function showTelegramTestNotification(toUser, title, message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 15px;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                border: 3px solid #4a90e2;
            `;

            notification.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 18px;">
                        ğŸ“± Telegram æ¸¬è©¦é€šçŸ¥
                    </h3>
                    <p style="margin: 5px 0; opacity: 0.9; font-size: 14px;">
                        ç™¼é€çµ¦ï¼š${toUser}
                    </p>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">${title}</h4>
                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; line-height: 1.4;">${message}</pre>
                </div>

                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="this.closest('div').remove()" style="
                        background: rgba(255,255,255,0.2);
                        color: white;
                        border: 1px solid rgba(255,255,255,0.3);
                        padding: 10px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        âœ… æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // 5ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // åˆå§‹åŒ–å‡½æ•¸
        function initPage() {
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦é é¢åˆå§‹åŒ–...');

            try {
                initializeTelegram();
                updateConfigStatus();
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°é…ç½®ç‹€æ…‹é¡¯ç¤º
        function updateConfigStatus() {
            const statusDiv = document.getElementById('configStatus');

            if (!window.TELEGRAM_CONFIG) {
                statusDiv.innerHTML = 'âŒ Telegram é…ç½®æœªè¼‰å…¥';
                statusDiv.style.background = 'rgba(220, 53, 69, 0.2)';
                return;
            }

            const config = window.TELEGRAM_CONFIG;
            const hasValidToken = config.botToken && config.botToken !== 'YOUR_BOT_TOKEN_HERE';
            const hasValidUsers = config.users && config.users.cat && config.users.mouse;

            let statusHtml = '<div>';
            statusHtml += `<div>ğŸ”§ é…ç½®è¼‰å…¥: âœ…</div>`;
            statusHtml += `<div>ğŸ¤– Bot Token: ${hasValidToken ? 'âœ… å·²è¨­å®š' : 'âŒ æœªè¨­å®š'}</div>`;
            statusHtml += `<div>ğŸ‘¥ ç”¨æˆ¶é…ç½®: ${hasValidUsers ? 'âœ… å·²è¨­å®š' : 'âŒ æœªè¨­å®š'}</div>`;
            statusHtml += `<div>ğŸš€ å•Ÿç”¨ç‹€æ…‹: ${config.enabled ? 'âœ… å·²å•Ÿç”¨' : 'â¸ï¸ æœªå•Ÿç”¨'}</div>`;
            statusHtml += `<div>ğŸ§ª æ¸¬è©¦æ¨¡å¼: ${config.testMode ? 'âœ… å•Ÿç”¨' : 'âŒ é—œé–‰'}</div>`;
            statusHtml += '</div>';

            statusDiv.innerHTML = statusHtml;

            if (config.enabled || config.testMode) {
                statusDiv.style.background = 'rgba(40, 167, 69, 0.2)';
            } else {
                statusDiv.style.background = 'rgba(255, 193, 7, 0.2)';
            }
        }

        // æ¸¬è©¦å‡½æ•¸å€‘
        function testInvitation() {
            console.log('ğŸ§ª æ¸¬è©¦é‚€è«‹é€šçŸ¥...');

            const mockEvent = {
                title: 'ä¸€èµ·çœ‹é›»å½±',
                date: '2024-12-20',
                time: '19:00',
                description: 'çœ‹æœ€æ–°ä¸Šæ˜ çš„æµªæ¼«é›»å½± ğŸ¬'
            };

            sendTelegramNotification('mouse', 'invitation', 'cat', mockEvent);
        }

        function testAccepted() {
            console.log('ğŸ§ª æ¸¬è©¦æ¥å—é€šçŸ¥...');

            const mockEvent = {
                title: 'å…¬åœ’æ•£æ­¥',
                date: '2024-12-21',
                time: '10:00',
                description: 'åœ¨å…¬åœ’è£¡äº«å—ç¾å¥½æ™‚å…‰ ğŸŒ³'
            };

            sendTelegramNotification('cat', 'accepted', 'mouse', mockEvent);
        }

        function testRejected() {
            console.log('ğŸ§ª æ¸¬è©¦æ‹’çµ•é€šçŸ¥...');

            const mockEvent = {
                title: 'çˆ¬å±±æ´»å‹•',
                date: '2024-12-22',
                time: '06:00',
                description: 'æ—©èµ·çˆ¬å±±çœ‹æ—¥å‡º ğŸŒ…'
            };

            sendTelegramNotification('cat', 'rejected', 'mouse', mockEvent);
        }

        function testReminder() {
            console.log('ğŸ§ª æ¸¬è©¦æé†’é€šçŸ¥...');

            const mockEvent = {
                title: 'ç´„æœƒæ™šé¤',
                date: '2024-12-23',
                time: '18:30',
                description: 'åœ¨é‚£å®¶æ–°é–‹çš„é¤å»³ ğŸ½ï¸'
            };

            sendTelegramNotification('mouse', 'reminder', null, mockEvent, '1å°æ™‚');
        }

        function clearLog() {
            document.getElementById('consoleLog').textContent = '';
            document.getElementById('testResults').innerHTML = 'æ—¥èªŒå·²æ¸…é™¤...';
        }

        // ç²å–å°æ–¹ç”¨æˆ¶
        function getOtherUser(user) {
            return user === 'cat' ? 'mouse' : 'cat';
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>